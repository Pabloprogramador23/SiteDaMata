# Configuração para o upstream da aplicação Node.js
# O Docker Compose criará um serviço chamado 'app' que pode ser resolvido por este nome
upstream node_app {
    server app:3000;
}

# Servidor principal para HTTP (porta 80)
server {
    listen 80;
    # IMPORTANTE: Substitua 'seu_dominio.com' pelo seu nome de domínio real
    server_name seu_dominio.com;

    # --- PASSO 1: REDIRECIONAR HTTP PARA HTTPS ---
    # Quando você tiver o HTTPS configurado (veja o bloco 'SERVIDOR HTTPS' abaixo),
    # DESCOMENTE as linhas abaixo para forçar todo o tráfego HTTP a usar HTTPS.
    # Isso é uma boa prática de segurança.
    #
    # location / {
    #     return 301 https://$host$request_uri;
    # }

    # --- PASSO 2: PROXY PARA A APLICAÇÃO NODE.JS (HTTP) ---
    # Se você não estiver redirecionando para HTTPS, este bloco irá servir a aplicação via HTTP.
    # Se estiver redirecionando, este bloco será ignorado.
    location / {
        proxy_pass http://node_app;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # --- PASSO 3: SERVIR ARQUIVOS ESTÁTICOS DIRETAMENTE (HTTP) ---
    # O Nginx pode servir arquivos estáticos (imagens, CSS, JS, etc.) diretamente,
    # o que é mais eficiente e alivia a carga do servidor Node.js.
    location ~* \.(?:jpg|jpeg|gif|png|ico|css|js|html|json|pdf)$ {
        # O 'root' deve apontar para o diretório de trabalho definido no Dockerfile
        root /usr/src/app;
        expires 1d; # Define um cache de 1 dia para arquivos estáticos
        add_header Cache-Control "public";
    }
}

# ==============================================================================
# SERVIDOR HTTPS (Configuração Detalhada)
#
# ESTE BLOCO ESTÁ COMENTADO. DESCOMENTE E CONFIGURE APÓS OBTER SEUS CERTIFICADOS SSL.
#
# --- COMO OBTER CERTIFICADOS SSL GRATUITOS COM CERTBOT (Let's Encrypt) ---
# 1. Certifique-se de que seu domínio esteja apontando para o IP da sua VPS.
# 2. Instale o Certbot na sua VPS. Ex: `sudo apt install certbot python3-certbot-nginx`
# 3. Execute o Certbot para obter os certificados. Ex: `sudo certbot --nginx -d seu_dominio.com`
#    O Certbot irá configurar automaticamente o Nginx para você, mas para o Docker Compose,
#    você precisará copiar os caminhos dos arquivos gerados.
# 4. Os certificados geralmente são salvos em `/etc/letsencrypt/live/seu_dominio.com/`.
#
# --- CONFIGURAÇÃO DO BLOCO HTTPS ---
# ==============================================================================
# server {
#     listen 443 ssl;
#     # IMPORTANTE: Substitua 'seu_dominio.com' pelo seu nome de domínio real
#     server_name seu_dominio.com;
#
#     # --- PASSO 4: APONTAR PARA OS ARQUIVOS DO SEU CERTIFICADO SSL ---
#     # DESCOMENTE e ajuste os caminhos para os seus arquivos de certificado.
#     # Estes caminhos devem corresponder aos volumes montados no docker-compose.yml.
#     ssl_certificate /etc/letsencrypt/live/seu_dominio.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/seu_dominio.com/privkey.pem;
#
#     # --- PASSO 5: CONFIGURAÇÕES DE SEGURANÇA SSL (RECOMENDADAS) ---
#     # Inclua as configurações de segurança geradas pelo Certbot ou use as padrão.
#     include /etc/letsencrypt/options-ssl-nginx.conf;
#     ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
#
#     # --- PASSO 6: PROXY PARA A APLICAÇÃO NODE.JS (HTTPS) ---
#     # Configuração de proxy para a aplicação Node.js via HTTPS.
#     location / {
#         proxy_pass http://node_app;
#         proxy_http_version 1.1;
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection 'upgrade';
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_cache_bypass $http_upgrade;
#     }
#
#     # --- PASSO 7: SERVIR ARQUIVOS ESTÁTICOS DIRETAMENTE (HTTPS) ---
#     # O Nginx também servirá arquivos estáticos via HTTPS.
#     location ~* \.(?:jpg|jpeg|gif|png|ico|css|js|html|json|pdf)$ {
#         root /usr/src/app;
#         expires 1d;
#         add_header Cache-Control "public";
#     }
# }
